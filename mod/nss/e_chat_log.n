extern("inc_chatlog")
extern("inc_cdb")

void main() {
	struct EventInfo ei = GetEventInfo();
	struct EventArguments ea = GetEventArguments(ei.serial);

	if (ei.ev != "chat_prefilter")
		return;

	if (ea.i0 & CHATMODE_DM_MODE)
		ea.i0 -= CHATMODE_DM_MODE;

	if (ei.runnable == ei.actedon) {
		FloatingTextStringOnCreature("Warnung: Diese Nachricht ging an dich selbst (falsch geklickt?): " +
			substr(ea.a0, 0, 10) + " ..", ei.runnable, false);
	}

	string mode = itoa(ea.i0);
	string aid = itoa(GetAccountID(ei.actor));
	string cid = itoa(GetCharacterID(ei.actor));
	SetLocalString(GetModule(),  "last_chat_message_text_" + mode + "_" + aid + "_" + cid, ea.a0);
	SetLocalObject(GetModule(), "last_chat_message_on_" + mode + "_" + aid + "_" + cid, ei.actedon);

	ChatLog(ei.actor, ea.i0, ea.a0, ei.actedon);
}
