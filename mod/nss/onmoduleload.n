__sp_extern("inc_mnx")
__sp_extern("_gen")
__sp_extern("inc_nwnx")
__sp_extern("inc_persist")
__sp_extern("inc_pc_data")
__sp_extern("inc_chat")
__sp_extern("inc_chat_run")
__sp_extern("x2_inc_switches")
__sp_extern("inc_setting")
__sp_extern("inc_online")

#include "inc_pgsql.nh"
#include "git.h"

void main() {
	object oMod = GetModule();
	int iHour, iDay, iMonth, iYear;


	SetMaxHenchmen(0xff);

	SetLocalString(GetModule(), "X2_S_UD_SPELLSCRIPT", "hook_spell");

	SetModuleSwitch(MODULE_SWITCH_ENABLE_CROSSAREA_WALKWAYPOINTS, TRUE);

	InitNWNX();
	pInit();
	ChatInit();
	mnxInit();

	RegisterAllCommands();

	ExecuteScript("_mod_load_cdb", GetModule());

	onlineServerStart();
	
	iYear = gvGetInt("t_year");
	iMonth = gvGetInt("t_month");
	iDay = gvGetInt("t_day");
	iHour = gvGetInt("t_hour");

	if ( !iYear )
		WriteTimestampedLogEntry("No time entry, starting with preset module time");
	else {
		WriteTimestampedLogEntry("Module time: " +
			IntToString(GetCalendarDay()) +
			". " + IntToString(GetCalendarMonth()) + ". " + IntToString(GetCalendarYear()));
		WriteTimestampedLogEntry("Restoring Date & Time: " +
			IntToString(iDay) + ". " + IntToString(iMonth) + ". " + IntToString(iYear) +
			" " + IntToString(iHour) + ":00");
		SetTime(iHour, 0, 0, 0);
		SetCalendar(iYear, 1, 1);
		if ( iMonth > 1 ) SetCalendar(iYear, iMonth, 1);
		if ( iDay > 1 ) SetCalendar(iYear, iMonth, iDay);
		WriteTimestampedLogEntry("Set module time to: " +
			IntToString(GetCalendarDay()) +
			". " + IntToString(GetCalendarMonth()) + ". " + IntToString(GetCalendarYear()));
	}

	// Global-Weather Setting
	//weather_setup();
	//weather_update();

	ExecuteScript("reg_subraces", OBJECT_SELF);
	WriteTimestampedLogEntry("Subraces initialized");
	ExecuteScript("reg_dispenser", OBJECT_SELF);
	WriteTimestampedLogEntry("Dispensers initialized");
	ExecuteScript("reg_spawn", OBJECT_SELF);
	WriteTimestampedLogEntry("Spawn system initialization in progress");
	ExecuteScript("reg_gods", OBJECT_SELF);
	WriteTimestampedLogEntry("God entries initialized");

	ExecuteScript("_events_register", OBJECT_SELF);

	SetLocalInt(oMod, "tracking", 1);

	SetLocalInt(oMod, "startup_ts", GetUnixTimestamp());

	WriteTimestampedLogEntry("Module initialization done.");

	mnx_asynchronous_command_noreply(mnx_prepare_command("startup", GIT_COMMIT));
}
