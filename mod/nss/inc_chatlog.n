#include "inc_pgsql.nh"
extern("inc_cdb")
extern("inc_chat")

void ChatLog(object oPC, int nMode, string sMessage, object oTo);


void ChatLog(object oPC, int nMode, string sMessage, object oTo) {
	// For now, do not log npc
	// if (!GetIsPC(oPC))
	//     return;
	// Log NPCs too.

	int nDontLogForArea = GetLocalInt(GetArea(oPC), "dont_log") == 1;

	if ( nDontLogForArea )
		return;



	string sHeardBy;
	int heard_count = 0;
	sHeardBy += "ARRAY[";
	iterate_players(
		if (oPC != oIterate && hears(oPC, oIterate, nMode & CHATMODE_TALK ? TALKVOLUME_TALK : TALKVOLUME_WHISPER) && GetCharacterID(oIterate) > 0) {
			heard_count += 1;
			sHeardBy += itoa(GetCharacterID(oIterate));
			sHeardBy += ",";
		}
	);
	if (heard_count > 0)
		sHeardBy = substr(sHeardBy, 0, strlen(sHeardBy) - 1);
	sHeardBy += "]";

	int
	nAID = GetAccountID(oPC),
	nCID = GetCharacterID(oPC),
	nTAID = GetAccountID(oTo),
	nTCID = GetCharacterID(oPC);

	string
	sAccount = pE(GetPCPlayerName(oPC)),
	sChar = pE(GetName(oPC)),
	sText = pE(sMessage),
	sArea = pE(GetTag(GetArea(oPC))),
	sAccTo = pE(GetPCPlayerName(oTo)),
	sCharTo = pE(GetName(oTo));

	if (heard_count > 0) {
		pQ(
			"insert into chatlogs (account,character,account_s,character_s,t_account,t_character,t_account_s,t_character_s,area,text,mode, heard_by) values("
			+
			IntToString(nAID) + ", " + IntToString(nCID) + ", " + sAccount + ", " + sChar + ", " +
			IntToString(nTAID) + ", "  + IntToString(nTCID) + ", " + sAccTo + ", " + sCharTo + ", " +
			sArea + ", " + sText + ", " + IntToString(nMode) + ", " + sHeardBy +
			");");

	} else {
		pQ(
			"insert into chatlogs (account,character,account_s,character_s,t_account,t_character,t_account_s,t_character_s,area,text,mode) values("
			+
			IntToString(nAID) + ", " + IntToString(nCID) + ", " + sAccount + ", " + sChar + ", " +
			IntToString(nTAID) + ", "  + IntToString(nTCID) + ", " + sAccTo + ", " + sCharTo + ", " +
			sArea + ", " + sText + ", " + IntToString(nMode) + 
			");");
	}

	// SQLQuery("delete from chatlog order by timestamp asc limit 0,500;");

}
