# This Makefile depends on some of NWNs resource files.
# In order to compile anything, you need NWN installed,
# and set this environment variable to the path. You can
# do this outside of make by exporting it in your shell
# environment. Example:
# export NWNHOME=/home/elven/nwn

# Also, to build anything useful, this Makefile depends on
# the path 'build' in this repository to be accessible
# through $PATH, $PERLLIB and $CLASSPATH.

# Settings below:

# The name of the module that is being built.
# Set this in your env.
# NWNMODNAME=www.sternenfall.org

# The current working branch in git.
BRANCH=$(shell git branch 2>&1| grep "*" | cut -d " " -f 2)

# The current commit hash.
COMMIT=$(shell git-rev-parse --short --verify HEAD)

# All areas, except those that should not be packaged.
# You can use this to exclude certain areas from being distributed
# to builders/devs.
AREAS=$(shell ls area/*.git area/*.are area/*.gic | grep -v ooc_solace)

# This gets packaged into your final module for
# deployment on a production server.
VALIDEXT=area/\*.git area/\*.are \
	dlg/\*.dlg utm/\*.utm utp/\*.utp uts/\*.uts utt/\*.utt utw/\*.utw \
	utc/\*.utc utd/\*.utd ute/\*.ute \
	itp/\*.itp ssf/\*.ssf \
	mod/\*.fac mod/\*.ifo mod/\*.jrl \
	`find uti -iname *.uti` \
 	nss/\*.ncs

# This gets packaged into a developer package, which has
# ALL content.
VALIDEXTDEV=$(AREAS) \
	dlg/\*.dlg utm/\*.utm utp/\*.utp uts/\*.uts utt/\*.utt utw/\*.utw \
	utc/\*.utc utd/\*.utd ute/\*.ute \
	`find uti -iname *.uti` \
	itp/\*.itp ssf/\*.ssf \
	mod/\*.fac mod/\*.ifo mod/\*.jrl \
	nss/\*.ncs nss/\*.nss

# The player package is a leightweight module variant for
# players to build their own areas, items, etc.
VALIDEXTPLAYER=utp/\*.utp \
	itp/placeablepalcus.itp \
	itp/doorpalcus.itp \
	itp/soundpalcus.itp \
	ssf/\*.ssf \
	mod/\*.fac mod/\*.jrl \
	override-player/\*

# What lists to generate?
LISTS=uti utp utc utm

# Where should autogenerated lists be put?
LISTHOME=$(HOME)/autogen


# End of settings.
# Now type "make all" and hope for the best. :)
# To generate the package lists, type "make lists". (optional!)

.PHONY: all path
all: package

path:
ifeq  "$(NWNHOME)" ""
	@echo "env var NWNHOME not set."
	exit 1
endif
ifeq  "$(LISTHOME)" ""
	@echo "env var LISTHOME not set."
	exit 1
endif
ifeq "$(NWNMODNAME)" ""
	@echo "env var NWNMODNAME not set."
	exit 1
endif

.PHONY: area
area:
	$(MAKE) -C area all

.PHONY: dlg
dlg:
	$(MAKE) -C dlg all

.PHONY: utc
utc: dlg
	$(MAKE) -C utc all

.PHONY: uti
uti:
	$(MAKE) -C uti all

.PHONY: utd
utd:
	$(MAKE) -C utd all

.PHONY: ute
ute:
	$(MAKE) -C ute all

.PHONY: utm
utm:
	$(MAKE) -C utm all

.PHONY: utp
utp:
	$(MAKE) -C utp all

.PHONY: uts
uts:
	$(MAKE) -C uts all

.PHONY: utt
utt:
	$(MAKE) -C utt all

.PHONY: utw
utw:
	$(MAKE) -C utw all

.PHONY: ssf
ssf:
	$(MAKE) -C ssf all

.PHONY: mod
mod: area
	$(MAKE) -C mod all

.PHONY: itp
itp: utc utd ute uti utp uts utm utt utw
	$(MAKE) -C itp all

.PHONY: scripts
scripts: path
	$(MAKE) -C nss

clean:
	$(MAKE) -C nss clean
	-rm *.mod

.PHONY: resources
resources: area dlg utc uti utd ute utm utp uts utt utw ssf mod itp scripts

local: resources
	erfpack.pl -m -o $(NWNMODNAME)-$(BRANCH).mod $(VALIDEXT)
	erfpack.pl -m -o $(NWNMODNAME)-$(BRANCH)-dev.mod $(VALIDEXTDEV)
	erfpack.pl -m -o $(NWNMODNAME)-$(BRANCH)-player.mod $(VALIDEXTPLAYER)

tar: local
	tar -czf $(NWNMODNAME)-$(BRANCH).tgz $(NWNMODNAME)-$(BRANCH).mod
	tar -czf $(NWNMODNAME)-$(BRANCH)-dev.tgz $(NWNMODNAME)-$(BRANCH)-dev.mod
	tar -czf $(NWNMODNAME)-$(BRANCH)-player.tgz $(NWNMODNAME)-$(BRANCH)-player.mod

# generates a new package with the current commit
package: path local

# installs all packaged in the relevant directories
install:
	cp -v $(NWNMODNAME)-$(BRANCH).mod $(NWNMODNAME)-$(BRANCH)-dev.mod $(NWNMODNAME)-$(BRANCH)-player.mod $(NWNHOME)/modules/
